<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Shield — Account Health Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --dark: #161e2d; --dark2: #1e2840; --dark3: #2c3750;
      --blue: #003DA5; --text: #f0f3f6; --muted: #8899a6;
      --red: #e53935; --orange: #ff9800; --yellow: #ffc107; --green: #43a047;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--dark); color:var(--text); -webkit-font-smoothing:antialiased; }

    nav { padding:0 clamp(1rem,4vw,2rem); background:rgba(22,30,45,0.95); border-bottom:1px solid var(--dark3); position:sticky; top:0; z-index:200; backdrop-filter:blur(16px); }
    .nav-inner { max-width:1400px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; height:60px; }
    .nav-brand { font-size:13px; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; display:flex; align-items:center; gap:6px; }
    .nav-brand span { color:var(--blue); }
    .nav-links { display:flex; gap:20px; align-items:center; }
    .nav-links a { font-size:12px; color:var(--muted); text-decoration:none; transition:color 0.2s; }
    .nav-links a:hover, .nav-links a.active { color:var(--text); }
    .demo-badge { font-size:9px; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); background:var(--dark3); padding:3px 8px; border-radius:3px; }
    .nav-book-btn {
      font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
      color: #4a9eff; text-decoration: none;
      border: 1px solid rgba(74,158,255,0.3); border-radius: 3px;
      padding: 5px 12px; transition: all 0.2s; white-space: nowrap;
    }
    .nav-book-btn:hover { border-color: #4a9eff; background: rgba(74,158,255,0.08); }

    .page { max-width:1400px; margin:0 auto; padding:clamp(1.5rem,3vw,2.5rem) clamp(1rem,3vw,2rem); }

    .page-header { margin-bottom:2rem; }
    .page-tag { font-size:10px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--blue); margin-bottom:10px; }
    .page-h1 { font-family:'Instrument Serif',serif; font-size:clamp(1.8rem,3.5vw,3rem); font-weight:400; line-height:1.1; margin-bottom:10px; }
    .page-h1 em { font-style:italic; color:var(--muted); }
    .page-sub { font-size:14px; color:var(--muted); max-width:640px; line-height:1.65; }

    .stats { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:2rem; }
    .stat { background:var(--dark2); border:1px solid var(--dark3); border-radius:8px; padding:16px 20px; }
    .stat-val { font-size:26px; font-weight:700; margin-bottom:4px; }
    .stat-lbl { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }
    .v-red { color:var(--red); } .v-orange { color:var(--orange); }
    .v-blue { color:var(--blue); } .v-green { color:var(--green); }

    /* Filter bar */
    .filter-bar { background:var(--dark2); border:1px solid var(--dark3); border-radius:8px; padding:12px 16px; margin-bottom:12px; display:flex; flex-wrap:wrap; gap:14px; align-items:center; }
    .filter-group { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .filter-label { font-size:10px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); white-space:nowrap; }
    .filter-pill { font-size:11px; font-weight:600; padding:4px 10px; border-radius:20px; border:1px solid var(--dark3); background:transparent; color:var(--muted); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
    .filter-pill:hover { border-color:var(--blue); color:var(--text); }
    .filter-pill.active { background:var(--blue); border-color:var(--blue); color:#fff; }
    .filter-divider { width:1px; height:24px; background:var(--dark3); }
    .sort-select { font-size:11px; color:var(--text); background:var(--dark3); border:1px solid var(--dark3); border-radius:6px; padding:4px 8px; cursor:pointer; }

    .main-grid { display:grid; grid-template-columns:1fr 380px; gap:20px; align-items:start; }

    .table-card { background:var(--dark2); border:1px solid var(--dark3); border-radius:10px; overflow:hidden; }
    .card-header { padding:16px 20px; border-bottom:1px solid var(--dark3); display:flex; justify-content:space-between; align-items:center; }
    .card-title { font-size:14px; font-weight:600; }
    .card-sub { font-size:11px; color:var(--muted); margin-top:2px; }
    table { width:100%; border-collapse:collapse; }
    th { font-size:10px; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); padding:10px 14px; text-align:left; border-bottom:1px solid var(--dark3); white-space:nowrap; }
    td { padding:11px 14px; font-size:13px; border-bottom:1px solid rgba(36,42,51,0.5); vertical-align:middle; }
    tr:last-child td { border-bottom:none; }
    tr.clickable-row { cursor:pointer; }
    tr.clickable-row:hover td { background:rgba(255,255,255,0.03); }
    .acct-name { font-weight:600; font-size:13px; }
    .acct-ind { font-size:11px; color:var(--muted); }
    .health-badge { display:inline-flex; align-items:center; gap:5px; font-size:11px; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; padding:3px 8px; border-radius:3px; }
    .h-critical { background:rgba(229,57,53,0.15); color:var(--red); }
    .h-elevated { background:rgba(255,152,0,0.15); color:var(--orange); }
    .h-monitor { background:rgba(255,193,7,0.15); color:var(--yellow); }
    .h-healthy { background:rgba(67,160,71,0.15); color:var(--green); }
    .score-bar { display:flex; align-items:center; gap:8px; }
    .score-track { flex:1; height:3px; background:var(--dark3); border-radius:2px; min-width:60px; }
    .score-fill { height:100%; border-radius:2px; }
    .score-num { font-size:12px; font-weight:600; min-width:28px; }
    .churn-flag { display:inline-block; font-size:10px; font-weight:700; padding:2px 6px; border-radius:3px; background:rgba(229,57,53,0.15); color:var(--red); letter-spacing:0.06em; text-transform:uppercase; }
    .rsr-tag { font-size:12px; color:var(--muted); }

    .right-col { display:flex; flex-direction:column; gap:20px; }

    .events-card { background:var(--dark2); border:1px solid var(--dark3); border-radius:10px; overflow:hidden; }
    .event-list { padding:8px; display:flex; flex-direction:column; gap:4px; max-height:480px; overflow-y:auto; }
    .event-item { background:var(--dark); border:1px solid var(--dark3); border-radius:6px; padding:10px 12px; cursor:pointer; transition:background 0.15s; }
    .event-item:hover { background:#1a2030; }
    .event-item.ev-critical { border-left:3px solid var(--red); }
    .event-item.ev-elevated { border-left:3px solid var(--orange); }
    .event-item.ev-positive { border-left:3px solid var(--green); }
    .ev-top { display:flex; justify-content:space-between; align-items:flex-start; gap:6px; margin-bottom:4px; }
    .ev-biz { font-size:12px; font-weight:600; line-height:1.3; }
    .ev-time { font-size:10px; color:var(--muted); white-space:nowrap; flex-shrink:0; }
    .ev-desc { font-size:11px; color:var(--muted); line-height:1.4; }
    .ev-expanded { font-size:12px; color:var(--text); line-height:1.5; margin-top:8px; padding-top:8px; border-top:1px solid var(--dark3); display:none; }
    .ev-meta { display:flex; gap:6px; margin-top:5px; }
    .ev-score { font-size:10px; font-weight:700; padding:1px 5px; border-radius:3px; }

    .spotlight-card { background:var(--dark2); border:1px solid var(--dark3); border-radius:10px; overflow:hidden; }
    .spotlight-list { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .spotlight-item { background:rgba(229,57,53,0.06); border:1px solid rgba(229,57,53,0.15); border-radius:8px; padding:14px; }
    .sp-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
    .sp-name { font-size:13px; font-weight:600; line-height:1.3; }
    .sp-pct { font-size:18px; font-weight:700; color:var(--red); flex-shrink:0; margin-left:8px; }
    .sp-rsr { font-size:11px; color:var(--muted); margin-bottom:6px; }
    .sp-factors { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px; }
    .sp-factor { font-size:10px; color:var(--muted); background:var(--dark3); padding:2px 6px; border-radius:3px; }
    .sp-action { font-size:11px; color:var(--orange); line-height:1.4; }

    /* Drawer */
    .drawer-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:300; opacity:0; pointer-events:none; transition:opacity 0.25s; }
    .drawer-overlay.open { opacity:1; pointer-events:all; }
    .drawer { position:fixed; top:0; right:0; bottom:0; width:420px; max-width:100vw; background:#1a1f26; border-left:1px solid #242a33; z-index:301; transform:translateX(100%); transition:transform 0.3s cubic-bezier(0.16,1,0.3,1); overflow-y:auto; }
    .drawer.open { transform:translateX(0); }
    .drawer-header { padding:20px; border-bottom:1px solid #242a33; display:flex; justify-content:space-between; align-items:flex-start; position:sticky; top:0; background:#1a1f26; z-index:10; }
    .drawer-close { background:none; border:none; color:var(--muted); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; }
    .drawer-close:hover { color:var(--text); }
    .drawer-body { padding:20px; }

    .d-name { font-size:18px; font-weight:700; margin-bottom:4px; }
    .d-badges { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    .d-badge { font-size:10px; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; padding:3px 8px; border-radius:3px; }
    .d-section-label { font-size:10px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
    .d-meta-row { display:flex; justify-content:space-between; padding:8px 12px; font-size:13px; border-bottom:1px solid #242a33; }
    .d-meta-row:last-child { border-bottom:none; }
    .d-meta-label { color:var(--muted); }
    .d-tag-list { display:flex; flex-wrap:wrap; gap:6px; }
    .d-tag { font-size:11px; color:var(--muted); background:var(--dark3); padding:3px 8px; border-radius:4px; }
    .d-action { background:rgba(255,152,0,0.08); border:1px solid rgba(255,152,0,0.25); border-radius:8px; padding:12px; margin-bottom:16px; font-size:13px; line-height:1.6; color:var(--text); }
    .d-action-label { font-size:10px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--orange); margin-bottom:6px; }

    footer { border-top:1px solid var(--dark3); padding:18px clamp(1rem,4vw,2rem); margin-top:2rem; }
    .footer-inner { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
    .footer-text { font-size:12px; color:#4a5568; }
    .footer-links { display:flex; gap:16px; }
    .footer-links a { font-size:12px; color:#4a5568; text-decoration:none; }
    .footer-links a:hover { color:var(--muted); }

    @media(max-width:1100px) { .main-grid { grid-template-columns:1fr; } }
    @media(max-width:700px) {
      .stats { grid-template-columns:repeat(2,1fr); }
      table { font-size:12px; } th,td { padding:8px 10px; }
      .drawer { width:100vw; }
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a href="/laundry/" class="nav-brand"><span>Branch Ops</span> Intel</a>
    <div class="demo-badge">Simulated Data · Cincinnati Pilot</div>
    <div class="nav-links">
      <a href="/laundry/service-shield/" class="active">Service Shield</a>
      <a href="/laundry/churn-risk/">Churn Risk</a>
      <a href="/laundry/route-intel/">Route Intel</a>
      <a href="/laundry/rep-coaching/">Rep Coaching</a>
      <a href="/laundry/cincinnati/">Pilot Overview</a>
      <a href="https://cal.com/eratner15/30min" target="_blank" class="nav-book-btn">Book Pilot Call</a>
    </div>
  </div>
</nav>

<!-- Drawer -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="accountDrawer">
  <div class="drawer-header">
    <div id="drawerTitle" style="font-size:15px;font-weight:600">Account Detail</div>
    <button class="drawer-close" onclick="closeDrawer()">✕</button>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
</div>

<div class="page">
  <div class="page-header">
    <div class="page-tag">Service Shield · Account Health Monitor · Cincinnati Pilot</div>
    <div class="page-h1">Real-time complaint detection.<br><em>Every account, all the time.</em></div>
    <p class="page-sub">A complaint that festers for 3 days costs accounts. Service Shield detects sentiment signals 48 hours earlier and routes them to the right RSR before escalation.</p>
  </div>

  <div class="stats" id="statsRow">
    <div class="stat"><div class="stat-val v-blue" id="totalAccounts">—</div><div class="stat-lbl">Accounts Monitored</div></div>
    <div class="stat"><div class="stat-val v-red" id="activeComplaints">—</div><div class="stat-lbl">Active Complaints</div></div>
    <div class="stat"><div class="stat-val v-orange" id="churnRiskCount">—</div><div class="stat-lbl">Churn Risk Flags</div></div>
    <div class="stat"><div class="stat-val v-green" id="avgHealth">—</div><div class="stat-lbl">Avg Health Score</div></div>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="filter-group">
      <span class="filter-label">Health</span>
      <button class="filter-pill active" data-filter="tier" data-val="">All</button>
      <button class="filter-pill" data-filter="tier" data-val="critical">Critical</button>
      <button class="filter-pill" data-filter="tier" data-val="elevated">Elevated</button>
      <button class="filter-pill" data-filter="tier" data-val="monitor">Monitor</button>
      <button class="filter-pill" data-filter="tier" data-val="healthy">Healthy</button>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group">
      <span class="filter-label">RSR</span>
      <button class="filter-pill active" data-filter="rsr" data-val="">All</button>
      <button class="filter-pill" data-filter="rsr" data-val="Mike T.">Mike T.</button>
      <button class="filter-pill" data-filter="rsr" data-val="Sandra K.">Sandra K.</button>
      <button class="filter-pill" data-filter="rsr" data-val="James R.">James R.</button>
      <button class="filter-pill" data-filter="rsr" data-val="Carlos P.">Carlos P.</button>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group">
      <span class="filter-label">Sort</span>
      <select class="sort-select" id="sortSelect">
        <option value="health_asc">Health Score ↑</option>
        <option value="contact_asc">Last Contact ↑</option>
        <option value="value_desc">Contract Value ↓</option>
      </select>
    </div>
  </div>

  <div class="main-grid">
    <div>
      <div class="table-card">
        <div class="card-header">
          <div>
            <div class="card-title">Account Health Table</div>
            <div class="card-sub">All Cincinnati accounts · <span id="tableCount">—</span> shown · Click row for details</div>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>Account</th>
                <th>Health Score</th>
                <th>Status</th>
                <th>Open Issues</th>
                <th>Last Contact</th>
                <th>Churn Risk</th>
                <th>RSR</th>
              </tr>
            </thead>
            <tbody id="accountBody">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:32px">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="events-card">
        <div class="card-header">
          <div><div class="card-title">Recent Events</div><div class="card-sub">Click to expand · Last 10 signals</div></div>
        </div>
        <div class="event-list" id="eventsList">
          <div style="text-align:center;color:var(--muted);padding:20px;font-size:13px">Loading...</div>
        </div>
      </div>

      <div class="spotlight-card">
        <div class="card-header">
          <div><div class="card-title">Churn Risk Spotlight</div><div class="card-sub">Top 3 at-risk accounts</div></div>
        </div>
        <div class="spotlight-list" id="spotlightList">
          <div style="text-align:center;color:var(--muted);padding:20px;font-size:13px">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <div class="footer-text">Service Shield · Cincinnati Pilot Demo · <a href="/laundry/" style="color:inherit">Platform Home</a></div>
    <div class="footer-links">
      <a href="/laundry/churn-risk/">Churn Risk</a>
      <a href="/laundry/rep-coaching/">Rep Coaching</a>
      <a href="/laundry/cincinnati/">Pilot Overview</a>
    </div>
  </div>
</footer>

<script>
function timeAgo(iso) {
  const diff = (Date.now() - new Date(iso)) / 1000;
  if (diff < 3600) return Math.round(diff / 60) + 'm ago';
  if (diff < 86400) return Math.round(diff / 3600) + 'h ago';
  return Math.round(diff / 86400) + 'd ago';
}
function tierClass(tier) {
  return { critical:'h-critical', elevated:'h-elevated', monitor:'h-monitor', healthy:'h-healthy' }[tier] || '';
}
function scoreColor(score) {
  if (score >= 85) return '#43a047';
  if (score >= 60) return '#ffc107';
  if (score >= 40) return '#ff9800';
  return '#e53935';
}
function evClass(urgency, type) {
  if (urgency === 'critical' || urgency === 'elevated') return 'ev-' + urgency;
  if (type === 'positive') return 'ev-positive';
  return '';
}
function deriveAction(a) {
  const rf = a.risk_factors || [];
  if (rf.includes('sizing_complaints') || rf.includes('wrong_items')) return 'Schedule sizing audit and bring replacement items on next delivery.';
  if (rf.includes('billing_dispute')) return 'Close billing ticket this week — bring corrected invoice in writing.';
  if (rf.includes('contract_renewal_approaching')) return 'Initiate early renewal conversation before the window closes.';
  if (rf.includes('competitive_inquiry')) return 'Offer loyalty pricing proactively — do not wait for the customer to raise it.';
  if (rf.includes('reduced_order_volume')) return 'Ask directly about program satisfaction; offer inventory count review.';
  if (rf.includes('key_contact_changed')) return 'Schedule in-person introduction with new contact before next cycle.';
  if (a.churn_risk) return 'Review account immediately — escalate to branch manager if needed.';
  return 'Proactive check-in recommended on next visit.';
}

let allAccounts = [];
let activeFilters = { tier: '', rsr: '' };
let sortMode = 'health_asc';

function applyFiltersAndRender() {
  let filtered = allAccounts.filter(a => {
    if (activeFilters.tier && a.health_tier !== activeFilters.tier) return false;
    if (activeFilters.rsr && a.assigned_rsr !== activeFilters.rsr) return false;
    return true;
  });

  if (sortMode === 'health_asc') filtered.sort((a, b) => a.health_score - b.health_score);
  else if (sortMode === 'contact_asc') filtered.sort((a, b) => a.last_contact_days - b.last_contact_days);
  else if (sortMode === 'value_desc') filtered.sort((a, b) => b.contract_value_annual - a.contract_value_annual);

  document.getElementById('tableCount').textContent = filtered.length;

  const tbody = document.getElementById('accountBody');
  tbody.innerHTML = filtered.map(a => {
    const sc = scoreColor(a.health_score);
    return `<tr class="clickable-row" onclick="openDrawer('${a.id}')">
      <td><div class="acct-name">${a.name}</div><div class="acct-ind">${a.industry}</div></td>
      <td>
        <div class="score-bar">
          <div class="score-track"><div class="score-fill" style="width:${a.health_score}%;background:${sc}"></div></div>
          <div class="score-num" style="color:${sc}">${a.health_score}</div>
        </div>
      </td>
      <td><span class="health-badge ${tierClass(a.health_tier)}">${a.health_tier}</span></td>
      <td style="text-align:center;font-weight:600;color:${a.open_complaints > 0 ? '#e53935' : '#8899a6'}">${a.open_complaints}</td>
      <td style="font-size:12px;color:${a.last_contact_days > 14 ? '#e53935' : '#8899a6'}">${a.last_contact_days}d ago</td>
      <td>${a.churn_risk ? '<span class="churn-flag">At Risk</span>' : '<span style="color:#4a5568;font-size:12px">—</span>'}</td>
      <td><span class="rsr-tag">${a.assigned_rsr}</span></td>
    </tr>`;
  }).join('');
}

function openDrawer(id) {
  const a = allAccounts.find(x => x.id === id);
  if (!a) return;
  const sc = scoreColor(a.health_score);
  const le = a.last_event || {};
  const action = deriveAction(a);

  document.getElementById('drawerTitle').textContent = a.name;
  document.getElementById('drawerBody').innerHTML = `
    <div class="d-name">${a.name}</div>
    <div class="d-badges">
      <span class="d-badge" style="background:var(--dark3);color:var(--muted)">${a.industry}</span>
      <span class="health-badge ${tierClass(a.health_tier)}">${a.health_tier}</span>
    </div>

    <div style="margin-bottom:20px">
      <div class="d-section-label">Health Score</div>
      <div style="font-size:32px;font-weight:700;color:${sc};margin-bottom:6px">${a.health_score}<span style="font-size:16px;color:var(--muted)">/100</span></div>
      <div style="height:6px;background:var(--dark3);border-radius:3px;overflow:hidden"><div style="width:${a.health_score}%;height:100%;background:${sc};border-radius:3px"></div></div>
    </div>

    ${a.open_complaints > 0 ? `
    <div style="background:rgba(229,57,53,0.08);border:1px solid rgba(229,57,53,0.2);border-radius:8px;padding:12px;margin-bottom:16px">
      <div class="d-section-label" style="color:var(--red);margin-bottom:6px">${a.open_complaints} Open Complaint${a.open_complaints > 1 ? 's' : ''}</div>
      ${le.summary ? `<div style="font-size:13px;color:#ef5350;line-height:1.5">${le.summary}</div>` : ''}
    </div>` : ''}

    ${a.churn_risk ? `
    <div style="background:rgba(229,57,53,0.1);border:1px solid rgba(229,57,53,0.3);border-radius:8px;padding:12px;margin-bottom:16px">
      <div class="d-section-label" style="color:var(--red);margin-bottom:4px">⚠ Churn Risk Flagged</div>
      <div style="font-size:20px;font-weight:700;color:var(--red)">${Math.round(a.churn_probability * 100)}% probability</div>
    </div>` : ''}

    ${(a.risk_factors || []).length > 0 ? `
    <div style="margin-bottom:16px">
      <div class="d-section-label">Risk Factors</div>
      <div class="d-tag-list">${a.risk_factors.map(r => `<span class="d-tag">${r.replace(/_/g,' ')}</span>`).join('')}</div>
    </div>` : ''}

    ${le.summary ? `
    <div style="margin-bottom:16px">
      <div class="d-section-label">Last Event</div>
      <div style="background:var(--dark3);border-radius:8px;padding:12px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px">${timeAgo(le.timestamp)} · ${le.type || '—'} · Sentiment ${le.sentiment}/10 · <span style="text-transform:uppercase;letter-spacing:0.06em">${le.urgency || '—'}</span></div>
        <div style="font-size:13px;color:var(--text);line-height:1.5">${le.summary}</div>
      </div>
    </div>` : ''}

    <div style="margin-bottom:16px">
      <div class="d-section-label">Account Details</div>
      <div style="background:var(--dark3);border-radius:8px;overflow:hidden">
        <div class="d-meta-row"><span class="d-meta-label">Contract Value</span><span style="font-weight:600">$${a.contract_value_annual?.toLocaleString()}/yr</span></div>
        <div class="d-meta-row"><span class="d-meta-label">Assigned RSR</span><span style="font-weight:600">${a.assigned_rsr}</span></div>
        <div class="d-meta-row" style="border-bottom:none"><span class="d-meta-label">Last Contact</span><span style="font-weight:600;color:${a.last_contact_days > 14 ? 'var(--red)' : 'var(--text)'}">${a.last_contact_days}d ago</span></div>
      </div>
    </div>

    <div class="d-action">
      <div class="d-action-label">→ Recommended Action</div>
      ${action}
    </div>
  `;

  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('accountDrawer').classList.add('open');
}

function closeDrawer() {
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('accountDrawer').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDrawer(); });

// Filter pills
document.querySelectorAll('.filter-pill').forEach(pill => {
  pill.addEventListener('click', () => {
    const ft = pill.dataset.filter;
    document.querySelectorAll(`.filter-pill[data-filter="${ft}"]`).forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    activeFilters[ft] = pill.dataset.val;
    applyFiltersAndRender();
  });
});
document.getElementById('sortSelect').addEventListener('change', e => {
  sortMode = e.target.value;
  applyFiltersAndRender();
});

async function loadData() {
  try {
    const res = await fetch('/laundry/api/service-shield');
    const data = await res.json();
    const { accounts, summary, recent_events, churn_spotlight } = data;
    allAccounts = accounts;

    document.getElementById('totalAccounts').textContent = summary.total_accounts;
    document.getElementById('activeComplaints').textContent = summary.open_complaints_total;
    document.getElementById('churnRiskCount').textContent = summary.churn_risk_count;
    document.getElementById('avgHealth').textContent = summary.avg_health_score + '/100';

    applyFiltersAndRender();

    // Events
    const evList = document.getElementById('eventsList');
    evList.innerHTML = recent_events.map((e, i) => {
      const sc = e.sentiment <= 3 ? '#e53935' : e.sentiment <= 5 ? '#ff9800' : '#43a047';
      const bgSc = e.sentiment <= 3 ? 'rgba(229,57,53,0.15)' : e.sentiment <= 5 ? 'rgba(255,152,0,0.15)' : 'rgba(67,160,71,0.15)';
      return `<div class="event-item ${evClass(e.urgency, e.type)}" onclick="toggleEvent(this)">
        <div class="ev-top"><div class="ev-biz">${e.account_name}</div><div class="ev-time">${timeAgo(e.timestamp)}</div></div>
        <div class="ev-desc">${e.summary}</div>
        <div class="ev-meta">
          <span class="ev-score" style="background:${bgSc};color:${sc}">${e.sentiment}/10</span>
          <span class="ev-score" style="background:var(--dark3);color:var(--muted)">${e.urgency}</span>
          <span class="ev-score" style="background:var(--dark3);color:var(--muted)">${e.assigned_rsr}</span>
        </div>
        <div class="ev-expanded">
          <strong style="color:var(--text)">${e.account_name}</strong> · Health: ${e.health_score}/100 · ${e.health_tier}<br>
          ${e.summary}<br>
          <span style="font-size:11px;color:var(--blue);margin-top:6px;display:inline-block;cursor:pointer" onclick="openDrawer('${e.account_id}');event.stopPropagation()">Open account detail →</span>
        </div>
      </div>`;
    }).join('');

    // Spotlight
    const spotList = document.getElementById('spotlightList');
    spotList.innerHTML = churn_spotlight.map(a => `<div class="spotlight-item">
      <div class="sp-top"><div class="sp-name">${a.name}</div><div class="sp-pct">${Math.round(a.churn_probability * 100)}%</div></div>
      <div class="sp-rsr">RSR: ${a.assigned_rsr} · $${a.contract_value_annual?.toLocaleString()}/yr</div>
      <div class="sp-factors">${(a.risk_factors||[]).map(f => `<span class="sp-factor">${f.replace(/_/g,' ')}</span>`).join('')}</div>
      <div class="sp-action">⚡ ${a.suggested_action?.slice(0, 100)}${a.suggested_action?.length > 100 ? '…' : ''}</div>
    </div>`).join('');

  } catch(e) {
    console.error(e);
  }
}

function toggleEvent(el) {
  const exp = el.querySelector('.ev-expanded');
  if (!exp) return;
  const isOpen = exp.style.display === 'block';
  exp.style.display = isOpen ? 'none' : 'block';
}

loadData();
setInterval(loadData, 30000);
</script>
</body>
</html>
