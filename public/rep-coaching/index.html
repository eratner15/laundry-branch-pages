<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rep Coaching Intelligence ‚Äî Cincinnati Pilot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --dark: #161e2d; --dark2: #1e2840; --dark3: #2c3750;
      --blue: #003DA5; --text: #f0f3f6; --muted: #8899a6;
      --red: #e53935; --orange: #ff9800; --yellow: #ffc107; --green: #43a047;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--dark); color:var(--text); -webkit-font-smoothing:antialiased; }

    nav { padding:0 clamp(1rem,4vw,2rem); background:rgba(22,30,45,0.95); border-bottom:1px solid var(--dark3); position:sticky; top:0; z-index:100; backdrop-filter:blur(16px); }
    .nav-inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; height:60px; }
    .nav-brand { font-size:13px; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; display:flex; align-items:center; gap:6px; }
    .nav-brand span { color:var(--blue); }
    .nav-links { display:flex; gap:20px; align-items:center; }
    .nav-links a { font-size:12px; color:var(--muted); text-decoration:none; transition:color 0.2s; }
    .nav-links a:hover, .nav-links a.active { color:var(--text); }
    .demo-badge { font-size:9px; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); background:var(--dark3); padding:3px 8px; border-radius:3px; }

    .page { max-width:1200px; margin:0 auto; padding:clamp(1.5rem,4vw,3rem) clamp(1rem,3vw,2rem); }

    .page-tag { font-size:10px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--blue); margin-bottom:12px; }
    .page-h1 { font-family:'Instrument Serif',serif; font-size:clamp(2rem,4vw,3.2rem); font-weight:400; line-height:1.1; margin-bottom:16px; }
    .page-h1 em { font-style:italic; color:var(--muted); }
    .page-sub { font-size:15px; color:var(--muted); max-width:640px; line-height:1.7; margin-bottom:2.5rem; }

    /* Branch metrics bar */
    .branch-metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:2.5rem; }
    .bm { background:var(--dark2); border:1px solid var(--dark3); border-radius:8px; padding:16px; text-align:center; }
    .bm-val { font-size:26px; font-weight:700; margin-bottom:4px; }
    .bm-lbl { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }

    /* Rep cards */
    .reps-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; margin-bottom:2.5rem; }
    .rep-card { background:var(--dark2); border:1px solid var(--dark3); border-radius:10px; overflow:hidden; }
    .rep-header { padding:20px 20px 16px; border-bottom:1px solid var(--dark3); cursor:pointer; user-select:none; transition:background 0.15s; }
    .rep-header:hover { background:rgba(255,255,255,0.02); }
    .rep-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .rep-name { font-size:17px; font-weight:700; margin-bottom:2px; }
    .rep-territory { font-size:12px; color:var(--muted); }
    .rep-header-right { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
    .trend-val { font-size:20px; font-weight:700; line-height:1; }
    .trend-lbl { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }
    .rep-chevron { font-size:12px; color:var(--muted); transition:transform 0.25s; }
    .rep-meta { display:flex; gap:20px; }
    .rm-item-val { font-size:18px; font-weight:700; color:var(--blue); }
    .rm-item-lbl { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }
    .rep-body { padding:16px 20px; }
    .rep-section-label { font-size:10px; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); margin-bottom:10px; margin-top:16px; }
    .rep-section-label:first-child { margin-top:0; }

    /* At-risk items accordion */
    .at-risk-list { display:flex; flex-direction:column; gap:6px; }
    .at-risk-item { background:var(--dark); border:1px solid var(--dark3); border-radius:6px; overflow:hidden; }
    .ar-summary { padding:12px; cursor:pointer; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; transition:background 0.15s; }
    .ar-summary:hover { background:rgba(255,255,255,0.02); }
    .ar-summary-left { min-width:0; }
    .ar-name { font-size:13px; font-weight:600; line-height:1.3; }
    .ar-urgency { font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; padding:2px 6px; border-radius:3px; flex-shrink:0; }
    .u-this-week { background:rgba(229,57,53,0.15); color:var(--red); }
    .u-this-month { background:rgba(255,152,0,0.15); color:var(--orange); }
    .ar-reason-preview { font-size:12px; color:var(--muted); line-height:1.4; margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ar-chevron { font-size:11px; color:var(--muted); transition:transform 0.2s; flex-shrink:0; margin-top:2px; }

    .ar-expanded { display:none; padding:0 12px 12px; border-top:1px solid var(--dark3); }
    .ar-expanded.open { display:block; }
    .ar-full-reason { font-size:12px; color:var(--muted); line-height:1.5; margin-bottom:8px; padding-top:10px; }
    .ar-action { font-size:12px; color:var(--blue); line-height:1.4; margin-bottom:10px; }
    .ar-action::before { content:'‚Üí '; }
    .ar-stats { display:flex; gap:12px; margin-bottom:10px; }
    .ar-stat { background:var(--dark2); border-radius:6px; padding:6px 10px; }
    .ar-stat-val { font-size:14px; font-weight:700; color:var(--red); }
    .ar-stat-lbl { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }
    .ar-contacted-btn { font-size:11px; font-weight:600; padding:6px 12px; border-radius:4px; border:1px solid var(--dark3); background:transparent; color:var(--muted); cursor:pointer; transition:all 0.2s; }
    .ar-contacted-btn.contacted { background:rgba(67,160,71,0.15); border-color:rgba(67,160,71,0.4); color:var(--green); }

    .win-box { background:rgba(67,160,71,0.08); border:1px solid rgba(67,160,71,0.2); border-radius:6px; padding:12px; font-size:12px; color:#66bb6a; line-height:1.5; }
    .win-box::before { content:'üèÜ Win of the week: '; font-weight:600; color:#43a047; }
    .coaching-box { background:rgba(0,61,165,0.06); border:1px solid rgba(0,61,165,0.15); border-radius:6px; padding:12px; font-size:12px; color:var(--muted); line-height:1.6; margin-top:8px; }
    .coaching-box strong { color:var(--text); }

    .branch-summary { background:var(--dark2); border:1px solid rgba(0,61,165,0.25); border-radius:10px; padding:clamp(1.5rem,3vw,2rem); margin-bottom:2rem; }
    .bs-label { font-size:10px; font-weight:700; letter-spacing:0.16em; text-transform:uppercase; color:var(--blue); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
    .bs-label::after { content:''; flex:1; height:1px; background:rgba(0,61,165,0.2); }
    .bs-title { font-size:16px; font-weight:600; margin-bottom:10px; }
    .bs-text { font-size:14px; color:var(--muted); line-height:1.75; }

    footer { border-top:1px solid var(--dark3); padding:18px clamp(1rem,4vw,2rem); margin-top:2rem; }
    .footer-inner { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
    .footer-text { font-size:12px; color:#4a5568; }
    .footer-links { display:flex; gap:16px; }
    .footer-links a { font-size:12px; color:#4a5568; text-decoration:none; }
    .footer-links a:hover { color:var(--muted); }

    @media(max-width:900px) { .reps-grid { grid-template-columns:1fr; } .branch-metrics { grid-template-columns:repeat(2,1fr); } }
    @media(max-width:500px) { .branch-metrics { grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a href="/laundry/" class="nav-brand"><span>Branch Ops</span> Intel</a>
    <div class="demo-badge">Demo Mode</div>
    <div class="nav-links">
      <a href="/laundry/service-shield/">Service Shield</a>
      <a href="/laundry/churn-risk/">Churn Risk</a>
      <a href="/laundry/route-intel/">Route Intel</a>
      <a href="/laundry/rep-coaching/" class="active">Rep Coaching</a>
      <a href="/laundry/cincinnati/">Pilot Overview</a>
    </div>
  </div>
</nav>

<div class="page">
  <div class="page-tag">Rep Coaching Intelligence ¬∑ Weekly Summaries ¬∑ Cincinnati Pilot</div>
  <div class="page-h1">Your top 3 at-risk accounts<br><em>before the team meeting.</em></div>
  <p class="page-sub">Synthesized coaching for every RSR. What accounts to call first, what to say, what patterns are emerging. Generated fresh each week ‚Äî no spreadsheets, no guesswork.</p>

  <!-- Branch Metrics Bar -->
  <div class="branch-metrics" id="branchMetrics">
    <div class="bm"><div class="bm-val" style="color:var(--red)" id="atRiskCount">9</div><div class="bm-lbl">At-Risk Accounts</div></div>
    <div class="bm"><div class="bm-val" id="responseTimeVal" style="color:var(--orange)">3.8d</div><div class="bm-lbl">Avg Complaint Response</div></div>
    <div class="bm"><div class="bm-val" style="color:var(--blue)" id="revenueRisk">$329K</div><div class="bm-lbl">Revenue at Risk</div></div>
    <div class="bm"><div class="bm-val" style="color:var(--green)" id="upsellOpen">14</div><div class="bm-lbl">Upsell Opportunities</div></div>
  </div>

  <div class="reps-grid" id="repsGrid">
    <div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:40px">Loading rep data...</div>
  </div>

  <div class="branch-summary" id="branchSummary">
    <div class="bs-label">Branch Coaching Summary ¬∑ AI Generated</div>
    <div class="bs-title">Weekly Branch Intelligence</div>
    <div class="bs-text" id="branchSummaryText">Loading...</div>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <div class="footer-text">Rep Coaching Intelligence ¬∑ Cincinnati Pilot Demo ¬∑ <a href="/laundry/" style="color:inherit">Platform Home</a></div>
    <div class="footer-links">
      <a href="/laundry/service-shield/">Service Shield</a>
      <a href="/laundry/churn-risk/">Churn Risk</a>
      <a href="/laundry/cincinnati/">Pilot Overview</a>
    </div>
  </div>
</footer>

<script>
function trendColor(trend) {
  if (trend === 'improving') return '#43a047';
  if (trend === 'declining') return '#e53935';
  return '#8899a6';
}
function urgencyClass(u) { return u === 'this_week' ? 'u-this-week' : 'u-this-month'; }
function urgencyLabel(u) { return u === 'this_week' ? 'This Week' : 'This Month'; }
function trendArrow(emoji, trend) {
  const colors = { improving: 'var(--green)', stable: 'var(--muted)', declining: 'var(--red)' };
  return `<span style="color:${colors[trend] || 'var(--muted)'}">${emoji}</span>`;
}

// localStorage for contacted state
function isContacted(repId, acctName) {
  return localStorage.getItem(`coached:${repId}:${acctName}`) === '1';
}
function toggleContacted(repId, acctName, btn) {
  const key = `coached:${repId}:${acctName}`;
  if (localStorage.getItem(key) === '1') {
    localStorage.removeItem(key);
    btn.textContent = 'Mark as Contacted';
    btn.classList.remove('contacted');
  } else {
    localStorage.setItem(key, '1');
    btn.textContent = '‚úì Contacted';
    btn.classList.add('contacted');
  }
}

function toggleRepCard(cardEl) {
  const body = cardEl.querySelector('.rep-body');
  const chevron = cardEl.querySelector('.rep-chevron');
  const isOpen = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'block';
  chevron.style.transform = isOpen ? 'rotate(-90deg)' : 'rotate(0deg)';
}

function toggleAtRisk(itemEl) {
  const exp = itemEl.querySelector('.ar-expanded');
  const chevron = itemEl.querySelector('.ar-chevron');
  const isOpen = exp.classList.contains('open');
  if (isOpen) {
    exp.classList.remove('open');
    chevron.style.transform = 'rotate(0deg)';
  } else {
    exp.classList.add('open');
    chevron.style.transform = 'rotate(180deg)';
  }
}

async function loadData() {
  try {
    const res = await fetch('/laundry/api/rep-coaching');
    const data = await res.json();

    const rt = data.branch_metrics.avg_complaint_response_days;
    document.getElementById('atRiskCount').textContent = data.branch_metrics.total_at_risk_accounts;
    const rtEl = document.getElementById('responseTimeVal');
    rtEl.textContent = rt + 'd';
    rtEl.style.color = rt < 2 ? 'var(--green)' : rt <= 4 ? 'var(--orange)' : 'var(--red)';
    document.getElementById('revenueRisk').textContent = '$' + (data.branch_metrics.total_revenue_at_risk / 1000).toFixed(0) + 'K';
    document.getElementById('upsellOpen').textContent = data.branch_metrics.upsell_opportunities_open;

    const grid = document.getElementById('repsGrid');
    grid.innerHTML = data.reps.map(rep => {
      const atRiskHtml = rep.at_risk_accounts.map(a => {
        const contacted = isContacted(rep.id, a.name);
        return `
          <div class="at-risk-item">
            <div class="ar-summary" onclick="toggleAtRisk(this.closest('.at-risk-item'))">
              <div class="ar-summary-left">
                <div class="ar-name">${a.name}</div>
                <div class="ar-reason-preview">${a.risk_reason}</div>
              </div>
              <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                <span class="ar-urgency ${urgencyClass(a.urgency)}">${urgencyLabel(a.urgency)}</span>
                <span class="ar-chevron">‚ñº</span>
              </div>
            </div>
            <div class="ar-expanded">
              <div class="ar-full-reason">${a.risk_reason}</div>
              <div class="ar-action">${a.suggested_action}</div>
              <div class="ar-stats">
                <div class="ar-stat"><div class="ar-stat-val">${Math.round(a.churn_probability * 100)}%</div><div class="ar-stat-lbl">Churn Risk</div></div>
                <div class="ar-stat"><div class="ar-stat-val" style="color:var(--blue)">$${(a.contract_value / 1000).toFixed(0)}K</div><div class="ar-stat-lbl">Contract</div></div>
                <div class="ar-stat"><div class="ar-stat-val" style="color:${a.urgency === 'this_week' ? 'var(--red)' : 'var(--orange)'}">${urgencyLabel(a.urgency)}</div><div class="ar-stat-lbl">Urgency</div></div>
              </div>
              <button class="ar-contacted-btn ${contacted ? 'contacted' : ''}"
                onclick="toggleContacted('${rep.id}', '${a.name.replace(/'/g,"\\'")}', this)">
                ${contacted ? '‚úì Contacted' : 'Mark as Contacted'}
              </button>
            </div>
          </div>`;
      }).join('');

      return `
        <div class="rep-card">
          <div class="rep-header" onclick="toggleRepCard(this.closest('.rep-card'))">
            <div class="rep-top">
              <div>
                <div class="rep-name">${rep.name}</div>
                <div class="rep-territory">${rep.territory}</div>
              </div>
              <div class="rep-header-right">
                <div class="trend-val" style="color:${trendColor(rep.health_trend)}">${rep.health_trend_emoji} ${rep.health_trend_delta > 0 ? '+' : ''}${rep.health_trend_delta}</div>
                <div class="trend-lbl">Health trend</div>
                <div class="rep-chevron">‚ñº</div>
              </div>
            </div>
            <div class="rep-meta">
              <div class="rm-item"><div class="rm-item-val">${rep.accounts_managed}</div><div class="rm-item-lbl">Accounts</div></div>
              <div class="rm-item"><div class="rm-item-val">${rep.avg_account_health}</div><div class="rm-item-lbl">Avg Health</div></div>
              <div class="rm-item"><div class="rm-item-val" style="color:${rep.metrics.avg_days_to_complaint_response <= 2 ? '#43a047' : '#ff9800'}">${rep.metrics.avg_days_to_complaint_response}d</div><div class="rm-item-lbl">Response</div></div>
            </div>
          </div>
          <div class="rep-body">
            <div class="rep-section-label">At-risk accounts this week</div>
            <div class="at-risk-list">${atRiskHtml}</div>
            <div class="rep-section-label" style="margin-top:14px">Win of the week</div>
            <div class="win-box">${rep.win_of_week}</div>
            <div class="rep-section-label" style="margin-top:14px">Coaching focus</div>
            <div class="coaching-box">${rep.coaching_focus}</div>
          </div>
        </div>`;
    }).join('');

    document.getElementById('branchSummaryText').textContent = data.branch_coaching_summary;
  } catch(e) {
    console.error(e);
  }
}
loadData();
</script>
</body>
</html>
